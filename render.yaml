services:
  - type: web
    name: baphomet-server
    env: node
    plan: free
    buildCommand: |
      echo "Installing pnpm..."
      npm install -g pnpm@8

      echo "Setting up .npmrc..."
      echo "shamefully-hoist=true" > .npmrc
      echo "strict-peer-dependencies=false" >> .npmrc
      echo "@collinlucke:registry=https://npm.pkg.github.com" >> .npmrc
      echo "//npm.pkg.github.com/:_authToken=${GIT_REGISTRY_TOKEN}" >> .npmrc

      echo "Installing dependencies..."
      pnpm install --frozen-lockfile --verbose

      echo "Building server..."
      pnpm run build

      echo "Checking dist directory contents:"
      ls -la dist/

      rm -f .npmrc
    startCommand: node dist/server.js
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
      - key: ATLAS_DB_USERNAME
        sync: false
      - key: ATLAS_DB_PASSWORD
        sync: false
      - key: MD5_PASSWORD_HASH
        sync: false
      - key: TMDB_API_KEY
        sync: false
      - key: REFRESH_TOKEN_SECRET
        sync: false
      - key: ACCESS_TOKEN_SECRET
        sync: false
